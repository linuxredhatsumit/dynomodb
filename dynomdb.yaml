ARG PROXY_NAME=docker.io/istio-proxyv2:1.25.5

FROM golang:1.22.3-bookworm AS builder

WORKDIR /app
COPY plugin/. .

RUN go mod tidy

ENV GOFLAGS=-buildvcs=false

RUN go build -o simple.so -buildmode=c-shared .

CMD ["tail","-f", "/dev/null"]

FROM $PROXY_NAME

COPY --from=builder --chmod=777 /app/simple.so /simple.so

ENTRYPOINT ["/usr/local/bin/pilot-agent"]
