import subprocess
from datetime import datetime

def get_hpa_data():
    result = subprocess.check_output(
        "kubectl get hpa -A -o jsonpath='{range .items[*]}{.metadata.namespace},{.metadata.name},{.spec.minReplicas},{.spec.maxReplicas}{\"\\n\"}{end}'",
        shell=True
    ).decode("utf-8")
    return result.strip().split("\n")

def scale_value(value, percent):
    return int(value * percent / 100)

def process(hpa_data, percent, cluster_label):
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    file_name = f"{cluster_label}_hpa_{timestamp}.txt"

    with open(file_name, "w") as f:
        for line in hpa_data:
            parts = line.split(",")
            if len(parts) != 4:
                continue

            ns, name, cur_min, cur_max = parts[0], parts[1], int(parts[2]), int(parts[3])

            # RULE 1: Services already below 4 â†’ Do NOT modify
            if cur_min < 4:
                new_min = cur_min
                new_max = cur_max
                comment = "SKIPPED (<4 current)"
            else:
                # RULE 2: Calculate scaling
                new_min = scale_value(cur_min, percent)
                new_max = scale_value(cur_max, percent)
                comment = "SCALED"

                # RULE 3: If result drops below 4 â†’ keep minimum 4
                if new_min < 4:
                    new_min = 4
                    comment = "FORCED_MIN_4"

                # RULE 4: Ensure Max >= Min
                if new_max < new_min:
                    new_max = new_min
                    if comment == "SCALED":
                        comment = "FORCED_MAX_UPDATED"

            f.write(f"{ns:<15} {name:<45} Min:{new_min:<4} Max:{new_max:<4}  [{comment}]\n")

    print(f"âœ” Output generated: {file_name}")


if __name__ == "__main__":
    print("\nâš  Ensure kubectl context = BLUE/PROD cluster before running\n")

    blue_percent = float(input("Enter % for Blue cluster (ex: 90): ").strip())
    green_percent = 100 - blue_percent

    print(f"\nâž¡ Blue = {blue_percent}% | Green = {green_percent}%\n")

    hpa_list = get_hpa_data()

    print("Generating Blue output fileâ€¦")
    process(hpa_list, blue_percent, "blue")

    print("\nGenerating Green output fileâ€¦")
    process(hpa_list, green_percent, "green")

    print("\nðŸŽ¯ Completed â€” ONLY files generated, nothing changed in Kubernetes\n")