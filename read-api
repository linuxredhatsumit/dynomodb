import subprocess
import argparse

def update_hpa(file_path, namespace, delimiter=None):
    """
    Update HPA min/max replicas for services based on a text file.
    
    Assumes file format:
    NAME <delimiter> MIN <delimiter> MAX
    """
    with open(file_path, "r") as f:
        lines = f.readlines()

    if not lines:
        print("File is empty!")
        return

    # Read header and determine indices
    header = lines[0].strip().split(delimiter) if delimiter else lines[0].strip().split()
    try:
        name_idx = header.index("NAME")
        min_idx = header.index("MIN")
        max_idx = header.index("MAX")
    except ValueError:
        # If header not present, assume first=NAME, second=MIN, third=MAX
        print("Header not found, assuming first=NAME, second=MIN, third=MAX")
        name_idx = 0
        min_idx = 1
        max_idx = 2

    # Loop through each service
    for line in lines[1:]:
        if not line.strip():
            continue
        cols = line.strip().split(delimiter) if delimiter else line.strip().split()
        service_name = cols[name_idx]
        min_replicas = int(cols[min_idx])
        max_replicas = int(cols[max_idx])

        print(f"Updating {service_name} â†’ Min: {min_replicas}, Max: {max_replicas}")

        # Patch HPA using kubectl
        patch_cmd = [
            "kubectl", "patch", "hpa", service_name,
            "-n", namespace,
            "--type=json",
            f'-p=[{{"op":"replace","path":"/spec/minReplicas","value":{min_replicas}}},'
            f'{{"op":"replace","path":"/spec/maxReplicas","value":{max_replicas}}}]'
        ]
        try:
            subprocess.run(patch_cmd, check=True)
        except subprocess.CalledProcessError as e:
            print(f"Failed to update {service_name}: {e}")

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Update Kubernetes HPA from text file")
    parser.add_argument("--file", required=True, help="Path to text file")
    parser.add_argument("--namespace", required=True, help="Kubernetes namespace")
    parser.add_argument("--delimiter", required=False, help="Delimiter in file (e.g., ',' for CSV, '\\t' for tab)")

    args = parser.parse_args()
    update_hpa(args.file, args.namespace, args.delimiter)
