import subprocess
from datetime import datetime
import math

MIN_THRESHOLD = 4


def get_hpa_data():
    result = subprocess.run(
        ["kubectl", "get", "hpa", "-A", "-o",
         "custom-columns=NS:.metadata.namespace,NAME:.metadata.name,MIN:.spec.minReplicas,MAX:.spec.maxReplicas"],
        stdout=subprocess.PIPE, text=True
    )
    lines = result.stdout.strip().split("\n")[1:]
    hpa_list = []
    for line in lines:
        parts = line.split()
        if len(parts) == 4:
            ns, name, min_r, max_r = parts
            hpa_list.append({
                "Namespace": ns,
                "Service": name,
                "CurrentMin": int(min_r),
                "CurrentMax": int(max_r)
            })
    return hpa_list


def calculate(new_percent_blue, new_percent_green, hpa_list):
    blue_data = []
    green_data = []

    for row in hpa_list:
        cm = row["CurrentMin"]
        cx = row["CurrentMax"]

        # MIN calculation
        if cm < MIN_THRESHOLD:
            blue_min = cm
            green_min = cm
        else:
            blue_min = max(math.floor(cm * new_percent_blue / 100), MIN_THRESHOLD)
            green_min = max(math.ceil(cm * new_percent_green / 100), MIN_THRESHOLD)

        # MAX calculation
        if cx < MIN_THRESHOLD:
            blue_max = cx
            green_max = cx
        else:
            blue_max = max(math.floor(cx * new_percent_blue / 100), blue_min)
            green_max = max(math.ceil(cx * new_percent_green / 100), green_min)

        base = f"{row['Namespace']:20} {row['Service']:40}"
        blue_data.append(f"{base} Min:{blue_min:<3} Max:{blue_max:<3}")
        green_data.append(f"{base} Min:{green_min:<3} Max:{green_max:<3}")

    return blue_data, green_data


def save_file(filename, lines):
    with open(filename, "w") as f:
        for line in lines:
            f.write(line + "\n")


if __name__ == "__main__":
    percent_blue = int(input("Enter % traffic for BLUE: "))
    percent_green = 100 - percent_blue

    hpa_list = get_hpa_data()
    blue_out, green_out = calculate(percent_blue, percent_green, hpa_list)

    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    blue_file = f"blue_hpa_{timestamp}.txt"
    green_file = f"green_hpa_{timestamp}.txt"

    save_file(blue_file, blue_out)
    save_file(green_file, green_out)

    print("\nFiles created successfully:")
    print(f"  ðŸ“„ {blue_file}")
    print(f"  ðŸ“„ {green_file}\n")
    print("To view files:")
    print(f"cat {blue_file}")
    print(f"cat {green_file}\n")
    print("âœ” No change applied to Kubernetes\n")