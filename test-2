trigger: none

parameters:
  - name: ImageTag
    displayName: "Docker Image Tag to promote"
    type: string
    default: ""

variables:
  - group: Kotak-ECR-Credentials
  - name: SERVICE_NAME
    value: k811-ms-kyc-bitly-submit-cronjob
  - name: ENV
    value: prod
  - name: DR-ENV
    value: prod-dr
  - name: BRANCH_NAME
    value: master
  - name: REPOSITORY_NAME
    value: kotak-811-devops-prod

  # Agent pools
  - name: UAT_POOL_NAME
    value: K811-DevOps
  - name: PROD_POOL_NAME
    value: k811-prod

  # Docker and ECR
  - name: PROD_PREFIX
    value: stable
  - name: PROD_AWS_REGION
    value: ap-south-1
  - name: PROD_AWS_ACCOUNT_ID
    value:  '718378052708'
  - name: PROD_ECR_FOLDER_NAME
    value: 811prodonb
  - name: PROD_ECR_REPO_NAME
    value: k811_cronjob_kyc_bitly_submit

  - name: SOURCE_AWS_REGION
    value: ap-south-1
  - name: SOURCE_AWS_ACCOUNT_ID
    value: '483584640083'
  - name: SOURCE_ECR_FOLDER_NAME
    value: 811uatonb
  - name: SOURCE_ECR_REPO_NAME
    value: k811_ms_kyc_bitly_submit_cronjob

  - name: HELM_CHARTS_PATH
    value: helm-charts/k811-ms-kyc-bitly-submit-cronjob/charts
  - name: HELM_S3BUCKET_URL
    value: s3://k811-onb-helmcharts/prod/k811-ms-kyc-bitly-submit-cronjob/
  - name: DR_HELM_S3BUCKET_URL
    value: s3://k811-onb-helmcharts-dr/prod/k811-ms-kyc-bitly-submit-cronjob/

  - name: KUBE_CONFIG_PATH
    value: /home/app_user/.kube/config-prod
  - name: NAMESPACE
    value: prod
  - name: DR_KUBE_CONFIG_PATH
    value: /home/app_user/.kube/config-onb-dr

stages:
  - stage: ECR_AND_HELM_UPDATE
    displayName: "Docker Pull & Push, Helm values update"
    pool:
      name: $(UAT_POOL_NAME)
    jobs:
      - job: UAT_IMAGE_AND_HELM
