stages:
  - stage: GitBuild
    displayName: "Git Build"
    jobs:
      - template: ../templates/git-build.yaml
        parameters:
          BRANCH_NAME: '${{ parameters.BRANCH_NAME }}'

  - stage: DockerBuild
    displayName: "Docker Build"
    dependsOn: GitBuild
    jobs:
      - template: ../templates/docker-build-cache.yaml
        parameters:
          Env: '${{ parameters.Env }}'
          BRANCH_NAME: '${{ parameters.BRANCH_NAME }}'

  - stage: HelmDeploy
    displayName: "Helm Deploy"
    dependsOn: DockerBuild
    jobs:
      - template: ../templates/helm-build.yaml
        parameters:
          Env: '${{ parameters.Env }}'
          BRANCH_NAME: '${{ parameters.BRANCH_NAME }}'

  - stage: PrismaScan
    displayName: "Prisma Scan"
    dependsOn: HelmDeploy
    jobs:
      - template: ../templates/prisma-scan.yaml
        parameters:
          BRANCH_NAME: '${{ parameters.BRANCH_NAME }}'

  - stage: CheckmarxScan
    displayName: "Checkmarx Scan"
    dependsOn: PrismaScan
    jobs:
      - template: ../templates/checkmarx-scan.yaml
        parameters:
          CheckMarxScan: '${{ parameters.CheckMarxScan }}'
