trigger: none

variables:
  - group: Kotak-ECR-Credentials
  - name: SERVICE_NAME
    value: k811-experiments
  - name: ENV
    value: dev-arm
#pool details
  - name: POOL_NAME
    value: 'K811-DevOps'
# Azure Git application Repository Details
  - name: REPOSITORY_NAME
    value: 811_app_ms_experiments
  - name: BRANCH_NAME
    value: development
# Docker details
  - name: AWS_REGION
    value: ap-south-1
  - name: AWS_ACCOUNT_ID
    value: '483584640083'
  - name: ECR_FOLDER_NAME
    value: 811devonb
  - name: ECR_REPO_NAME
    value: k811_ms_experiments
# For AWS Role Access
  - name: ROLE_NAME
    value: EKS_Setup_Role
# Dockerfile Path
  - name: DOCKERFILE_PATH
    value: docker/app/Dockerfile
# helm related variables
  - name: HELM_CHARTS_PATH
    value: helm-charts/k811-experiments/charts
  - name: HELM_S3BUCKET_URL
    value: s3://kotak811-helmcharts/dev/k811-experiments/
  - name: KUBE_CONFIG_PATH
    value: /home/app_user/.kube/config-dev-arm
  - name: NAMESPACE
    value: dev

parameters:
  - name: Env
    displayName: Env
    type: string
    default: dev-arm
  - name: BRANCH_NAME
    displayName: BRANCH_NAME
    type: string
    default: development
  - name: CheckMarxScan
    displayName: CheckMarxScan
    type: string
    default: 'enable'
    values:
    - enable
    - disable

pool:
  name: $(POOL_NAME)

stages:
  - template: ../templates/git-build.yaml
    parameters:
      BRANCH_NAME: '${{ parameters.BRANCH_NAME }}'
      
  - template: ../templates/docker-build-cache.yaml
    parameters:
      Env: '${{ parameters.Env }}'
      BRANCH_NAME: '${{ parameters.BRANCH_NAME }}'

  - template: ../templates/helm-build.yaml
    parameters:
      Env: '${{ parameters.Env }}'
      BRANCH_NAME: '${{ parameters.BRANCH_NAME }}'
  
  - template: ../templates/prisma-scan.yaml
    parameters:
      BRANCH_NAME: '${{ parameters.BRANCH_NAME }}'
    
  - template: ../templates/checkmarx-scan.yaml
    parameters:
      CheckMarxScan: '${{ parameters.CheckMarxScan }}'
