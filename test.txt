namespace: 811-uat
cron_name: k811-ms-kyc-bitly-submit-cronjob
schedule: '"*/10 * * * *"'
timezone: "Asia/Kolkata"
restartPolicy: OnFailure

image:
  repository: 483584640083.dkr.ecr.ap-south-1.amazonaws.com/811uatonb/k811_ms_kyc
  tag: 811_app_ms_kyc-development-20230522.1
  pullPolicy: IfNotPresent

serviceaccount:
  name: 811-onb-uat-sa-kyc

configmap:
  name: k811-kyc-configmap

arguments:
  - sh
  - -c
  - |
    echo "check the logs"
    opentelemetry-instrument python3 /k811/app/cron_jobs/bitly_submit_retry.py

appconfig:
  OTEL_EXPORTER_OTLP_ENDPOINT: "http://$(NODE):4318"
########################################
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ .Values.cron_name }}
  namespace: {{ .Values.namespace }}
  labels:
    app: {{ .Values.cron_name }}
    chart: "{{ .Chart.Name }}-{{ .Chart.Version | replace "+" "_" }}"
spec:
  schedule: {{ .Values.schedule }}
  timeZone: {{ .Values.timezone }}
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: {{ .Values.cron_name }}
            sidecar.istio.io/inject: "false"
        spec:
          serviceAccountName: {{ .Values.serviceaccount.name }}
          restartPolicy: {{ .Values.restartPolicy }}
          containers:
            - name: {{ .Values.cron_name }}
              image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
              imagePullPolicy: {{ .Values.image.pullPolicy }}
              args:
              {{- toYaml .Values.arguments | nindent 16 }}
              envFrom:
                - configMapRef:
                    name: {{ .Values.configmap.name }}
              env:
                - name: NODE
                  valueFrom:
                    fieldRef:
                      fieldPath: status.hostIP
                - name: OTEL_EXPORTER_OTLP_ENDPOINT
                  value: {{ .Values.appconfig.OTEL_EXPORTER_OTLP_ENDPOINT }}
