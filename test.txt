parameters:
  - name: Jira_URL
    type: string
    default: ""
    displayName: "Jira URL"

stages:
  - stage: ECR_PROMOTE
    displayName: "Promote Docker Image from UAT to PROD"
    pool:
      name: $(DEVOPS_POOL_NAME)
    jobs:
      - job: PromoteUATImageToPROD
        displayName: "Promote UAT Docker Image to PROD ECR"
        steps:

          # Step 1: Assume UAT role and export credentials
          - script: |
              echo "Assuming UAT role to pull image..."
              unset AWS_SESSION_TOKEN
              unset AWS_SECRET_ACCESS_KEY
              unset AWS_ACCESS_KEY_ID

              CREDENTIALS=$(aws sts assume-role \
                --role-arn arn:aws:iam::$(SOURCE_AWS_ACCOUNT_ID):role/$(UAT_ROLE_NAME) \
                --role-session-name "$(Build.DefinitionName)-$(Build.BuildNumber)")

              export AWS_ACCESS_KEY_ID=$(echo $CREDENTIALS | jq -r '.Credentials.AccessKeyId')
              export AWS_SECRET_ACCESS_KEY=$(echo $CREDENTIALS | jq -r '.Credentials.SecretAccessKey')
              export AWS_SESSION_TOKEN=$(echo $CREDENTIALS | jq -r '.Credentials.SessionToken')

              echo "Logging in to UAT ECR..."
              aws ecr get-login-password --region $(SOURCE_AWS_REGION) | docker login --username AWS --password-stdin $(SOURCE_AWS_ACCOUNT_ID).dkr.ecr.$(SOURCE_AWS_REGION).amazonaws.com

              echo "Pulling image from UAT..."
              docker pull $(SOURCE_AWS_ACCOUNT_ID).dkr.ecr.$(SOURCE_AWS_REGION).amazonaws.com/$(SOURCE_ECR_FOLDER_NAME)/$(SOURCE_ECR_REPO_NAME):$(IMAGE_TAG)
            displayName: "Assume UAT role and pull image"

          # Step 2: Tag and Push to PROD ECR
          - script: |
              echo "Tagging image for PROD..."
              docker tag \
                $(SOURCE_AWS_ACCOUNT_ID).dkr.ecr.$(SOURCE_AWS_REGION).amazonaws.com/$(SOURCE_ECR_FOLDER_NAME)/$(SOURCE_ECR_REPO_NAME):$(IMAGE_TAG) \
                $(PROD_AWS_ACCOUNT_ID).dkr.ecr.$(PROD_AWS_REGION).amazonaws.com/$(PROD_ECR_FOLDER_NAME)/$(PROD_ECR_REPO_NAME):$(PROD_PREFIX)-$(IMAGE_TAG)

              echo "Logging in to PROD ECR..."
              aws ecr get-login-password --region $(PROD_AWS_REGION) | docker login --username AWS --password-stdin $(PROD_AWS_ACCOUNT_ID).dkr.ecr.$(PROD_AWS_REGION).amazonaws.com

              echo "Pushing image to PROD..."
              docker push $(PROD_AWS_ACCOUNT_ID).dkr.ecr.$(PROD_AWS_REGION).amazonaws.com/$(PROD_ECR_FOLDER_NAME)/$(PROD_ECR_REPO_NAME):$(PROD_PREFIX)-$(IMAGE_TAG)
            displayName: "Tag and push to PROD ECR"
