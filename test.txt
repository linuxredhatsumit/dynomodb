trigger: none

variables:
  - group: AWS-keys
  - group: AWS-reference-keys
  - group: Kotak-ECR-Credentials
  - name: SERVICE_NAME
    value: k811-gst
  - name: ENV
    value: dev-arm
  - name: POOL_NAME
    value: 'K811-DevOps'
  - name: PYTHON_VERSION
    value: '3.10'
  - name: REPOSITORY_NAME
    value: 811_app_ms_gst
  - name: BRANCH_NAME
    value: development
  - name: AWS_REGION
    value: ap-south-1
  - name: AWS_ACCOUNT_ID
    value: '483584640083'
  - name: ECR_FOLDER_NAME
    value: 811devonb
  - name: ECR_REPO_NAME
    value: k811_ms_gst
  - name: ROLE_NAME
    value: EKS_Setup_Role
  - name: DOCKERFILE_PATH
    value: docker/app/Dockerfile
  - name: HELM_CHARTS_PATH
    value: helm-charts/k811-gst/charts
  - name: HELM_S3BUCKET_URL
    value: s3://kotak811-helmcharts/dev/k811-gst/
  - name: KUBE_CONFIG_PATH
    value: /home/app_user/.kube/config-dev-arm
  - name: NAMESPACE
    value: dev

parameters:
  - name: Env
    displayName: Env
    type: string
    default: dev-arm
  - name: BRANCH_NAME
    displayName: BRANCH_NAME
    type: string
    default: development
  - name: CheckMarxScan
    displayName: CheckMarxScan
    type: string
    default: 'enable'
    values:
      - enable
      - disable

pool:
  name: $(POOL_NAME)

stages:
  # Stage 1: Git Build
  - stage: GitBuild
    displayName: "Git Build Stage"
    jobs:
      - template: ../templates/git-build.yaml
        parameters:
          BRANCH_NAME: '${{ parameters.BRANCH_NAME }}'

  # Stage 2: Docker Build
  - stage: DockerBuild
    displayName: "Docker Build Stage"
    dependsOn: GitBuild
    jobs:
      - template: ../templates/docker-build-cache.yaml
        parameters:
          Env: '${{ parameters.Env }}'
          BRANCH_NAME: '${{ parameters.BRANCH_NAME }}'

  # Stage 3: Helm Deploy
  - stage: HelmDeploy
    displayName: "Helm Deploy Stage"
    dependsOn: DockerBuild
    jobs:
      - template: ../templates/helm-build.yaml
        parameters:
          Env: '${{ parameters.Env }}'
          BRANCH_NAME: '${{ parameters.BRANCH_NAME }}'

  # Stage 4: Prisma Scan
  - stage: PrismaScan
    displayName: "Prisma Security Scan"
    dependsOn: HelmDeploy
    jobs:
      - template: ../templates/prisma-scan.yaml
        parameters:
          BRANCH_NAME: '${{ parameters.BRANCH_NAME }}'

  # Stage 5: Checkmarx Scan
  - stage: CheckmarxScan
    displayName: "Checkmarx Scan"
    dependsOn: PrismaScan
    jobs:
      - template: ../templates/checkmarx-scan.yaml
        parameters:
          CheckMarxScan: '${{ parameters.CheckMarxScan }}'
